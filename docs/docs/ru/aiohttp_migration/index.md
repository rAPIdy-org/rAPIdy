---
hide:
  - navigation
---

# Миграция на Rapidy с aiohttp

## Описание
`rapidy` аккуратно расширяет `aiohttp`, что означает: весь код, написанный на `aiohttp`, будет работать без изменений.

!!! info ""
    `rapidy` использует те же имена модулей, что и `aiohttp`.

!!! note ""
    Если нужного объекта нет в `rapidy`, его можно импортировать напрямую из `aiohttp`.

---

## Проблемы `aiohttp` и их решения в `Rapidy`
Фреймворк `aiohttp` имеет ряд особенностей и ограничений, которые `Rapidy` решает более удобным и элегантным способом.

### Упрощение работы с параметром `request`
В `aiohttp` обработчики маршрутов требуют явного указания параметра `request`, даже если он не используется.

**Пример `aiohttp`:**
```python
{!> ./docs/aiohttp_migration/01_aiohttp_problems/request/aiohttp.py !}
```

В `Rapidy` параметр `request` указывать не нужно, что делает код лаконичнее:

**Пример `Rapidy`:**
```python
{!> ./docs/aiohttp_migration/01_aiohttp_problems/request/rapidy.py !}
```

!!! tip "Подробнее о возможностях обработки `Request` можно прочитать **[здесь](../docs/server/request)**."

---
### Упрощённая работа с фоновыми задачами
В `aiohttp` обработчики фоновых задач требуют явного указания параметра `app`:
```python
{!> ./docs/aiohttp_migration/01_aiohttp_problems/bg_tasks/aiohttp.py !}
```

В `Rapidy` параметр `app` не требуется:
```python
{!> ./docs/aiohttp_migration/01_aiohttp_problems/bg_tasks/rapidy.py !}
```

!!! tip "Передать атрибут `app` по-прежнему можно, подробнее **[здесь](../docs/lifespan)**."
!!! tip "Подробнее о возможностях работы с фоновыми задачами можно прочитать **[здесь](../docs/lifespan)**."

---

### Улучшенный роутинг классовых обработчиков
В `aiohttp` маршрутизация классовых обработчиков привязана к именам HTTP-методов, что ограничивает гибкость.

В `Rapidy` можно удобно группировать обработчики:
```python
{!> ./docs/aiohttp_migration/01_aiohttp_problems/class_handlers/rapidy.py !}
```

!!! tip "Подробнее о возможностях работы с HTTP-обработчиками можно прочитать **[здесь](../docs/server/handlers)**."

---

### Простая валидация и сериализация данных
В `Rapidy` можно легко валидировать и сериализовать данные запросов с помощью `pydantic`:
```python
{!> ./docs/aiohttp_migration/01_aiohttp_problems/validation/rapidy.py !}
```

---

### Более простое деление приложения на модули
В `aiohttp` подключение подприложений требует явного добавления маршрутов и инициализации объектов `Application`:
```python
{!> ./docs/aiohttp_migration/01_aiohttp_problems/sub_apps/aiohttp.py !}
```

В `Rapidy` это реализуется проще:
```python
{!> ./docs/aiohttp_migration/01_aiohttp_problems/sub_apps/rapidy.py !}
```

---

### Ключевые преимущества `Rapidy`
- **Более лаконичный код**: минимизация шаблонного кода без потери читаемости.
- **Удобная работа с маршрутизацией**: возможность группировки обработчиков в классах.
- **Гибкая валидация и сериализация данных**: встроенная поддержка `pydantic`.
- **Упрощённая работа с запросами и ответами**: доступ к `Request` и `Response` через аннотации типов.
- **Продвинутое управление жизненным циклом приложения**: удобные хуки `on_startup`, `on_shutdown` и `on_cleanup`.
- **Лучшая интеграция с асинхронными возможностями Python**: меньше лишних параметров и ручной обработки данных.

!!! tip "Подробнее о возможностях `Rapidy` можно прочитать **[здесь](../docs)**."

## Как мигрировать с `aiohttp` на `Rapidy`

Миграция с `aiohttp` на `Rapidy` значительно упрощает код, устраняя шаблонный код, улучшая валидацию и упрощая работу с зависимостями.

### Полная миграция
Допустим, у вас есть `aiohttp`-приложение с обработчиком запроса, параметрами запроса, валидацией и хуками жизненного цикла:

**Код на `aiohttp`**:
```python
{!> ./docs/aiohttp_migration/02_migration/full/aiohttp.py !}
```

**Код на `Rapidy`**:
```python
{!> ./docs/aiohttp_migration/02_migration/full/rapidy.py !}
```

Основные улучшения:

- **Меньше шаблонного кода** — нет явного `request: web.Request`, `Rapidy` сам парсит JSON и валидирует его с `pydantic`.
- **Проще работа с жизненным циклом** — `on_startup` передаётся списком, без `app.on_startup.append()`.
- **Маршрутизация без `app.add_routes()`** — обработчики передаются через `http_route_handlers`.

---

### Частичная миграция
Иногда полная миграция невозможна сразу. Например, если нужно добавить функциональность, но сохранить часть кода на `aiohttp`.
В таком случае можно адаптировать код постепенно.

Этот подход позволяет переносить код на `Rapidy`, заменяя части `aiohttp` на новый синтаксис без переписывания всего проекта.

#### Добавление небольшой функциональности
Допустим, вам нужно получить заголовок `Host` и передать его в ответ, не меняя остальную логику.

**Было (`aiohttp`)**:
```python
{!> ./docs/aiohttp_migration/02_migration/partial/minor/aiohttp.py !}
```

**Стало (`Rapidy`)**:
```python hl_lines="1 13 19 20"
{!> ./docs/aiohttp_migration/02_migration/partial/minor/rapidy.py !}
```

Изменения:

1. Обновлены импорты.
2. Добавлен `host: str = web.Header(alias='Host')` в HTTP-обработчике `create_user`.
3. `json_response` заменён на `Response`, так как теперь его функции встроены в `Response`.

!!! tip "`Response` в `Rapidy` умеет больше, подробнее **[здесь](../docs/server/response)**."

!!! info "Rapidy может все _(почти все)_"
    Пример выше описывает как можно дорабатывать код при объявлении HTTP-обработчиков с помощью `web.RouteTableDef()`,
    но `Rapidy` также поддерживает все другие возможные типы объявления HTTP-обработчиков в стиле `aiohttp`,
    подробнее о способах объявления обработчиков в стеле `aiohttp` читайте **[здесь](../docs/server/handlers)**.

#### Добавление новой функциональности через под-приложения
Вы можете легко расширить существующее приложение на `aiohttp`, добавляя новые возможности с помощью под-приложений.

**Было (`aiohttp`)**:
```python
{!> ./docs/aiohttp_migration/02_migration/partial/subapp/aiohttp.py !}
```

**Стало (`Rapidy`)**:
```python hl_lines="1 2 14 20 21 22 24 27"
{!> ./docs/aiohttp_migration/02_migration/partial/subapp/rapidy.py !}
```

Этот подход позволяет плавно интегрировать `Rapidy` в существующий код, не требуя значительных изменений.

!!! warning "Тем не менее, вам потребуется обновить импорты `aiohttp` на `rapidy` и заменить `json_response` на `Response` по всему коду."
